name: CI

env:
    BUN_VERSION: 1.1.43
    BUILD_DIR_GITHUB: ./build/github
    BUILD_DIR_NETLIFY: ./build/netlify

permissions:
    actions: read
    contents: write

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    repository_dispatch:
        types: [contentful-content-changed]
    workflow_dispatch:
        inputs:
            deploy_github:
                description: "Deploy to GitHub Pages"
                required: false
                default: true
                type: boolean
            deploy_netlify:
                description: "Deploy to Netlify"
                required: false
                default: true
                type: boolean

# Only execute the latest main or dispatch (CMS update/Manual) runs
concurrency:
    group: ${{
        github.head_ref ||
        (github.event_name == 'workflow_dispatch' && 'workflow_dispatch') ||
        (github.event_name == 'repository_dispatch' && 'repository_dispatch') ||
        (github.ref_name == 'main' && 'push-main')
        }}
    cancel-in-progress: ${{ 
        github.event_name != 'pull_request' || 
        github.event_name == 'repository_dispatch' ||
        github.event_name == 'workflow_dispatch'
        }}

jobs:
    build:
        runs-on: ubuntu-24.04
        env:
            IS_CONTENT_UPDATE: ${{ github.event_name == 'repository_dispatch' }}
            IS_PR: ${{ github.event_name == 'pull_request' }}
            RUN_STAGING: ${{
                (
                    github.event_name != 'workflow_dispatch' && 
                    github.event_name != 'repository_dispatch'
                ) ||
                (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_github =='true')
                }}
            RUN_PRODUCTION: ${{
                (github.event_name != 'pull_request' && github.event_name != 'workflow_dispatch') ||
                (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_netlify=='true')
                }}
        outputs:
            run_staging: ${{ env.RUN_STAGING }}
            run_production: ${{ env.RUN_PRODUCTION }}
        steps:
            - name: checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: setup
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: install
              run: bun install

            - name: check
              if: ${{ env.IS_CONTENT_UPDATE == 'false' }}
              run: bun run check:ci

            - name: content
              if: ${{ env.IS_PR == 'false' }}
              run: bun run util:content
              env:
                  CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
                  CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}

            - name: build for GitHub
              if: ${{ env.RUN_STAGING == 'true' }}
              run: bun run build
              env:
                  DEPLOY_TARGET: github

            - name: upload Github artifact
              if: ${{ env.RUN_STAGING == 'true' }}
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ${{ env.BUILD_DIR_GITHUB }}

            - name: build for Netlify
              if: ${{ env.RUN_PRODUCTION == 'true' }}
              run: bun run build:netlify
              env:
                  DEPLOY_TARGET: netlify

            - name: upload Netlify artifact
              if: ${{ env.RUN_PRODUCTION == 'true' }}
              uses: actions/upload-artifact@v4
              with:
                  name: netlify
                  path: ${{ env.BUILD_DIR_NETLIFY }}

    test:
        runs-on: ubuntu-24.04
        needs: build
        if: ${{ needs.build.outputs.run_production == 'true' }}
        steps:
            - name: checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: setup
              uses: oven-sh/setup-bun@v2
              with:
                    bun-version: ${{ env.BUN_VERSION }}

            - name: install
              run: bun install

            - name: download Netlify artifact
              uses: actions/download-artifact@v4
              with:
                  name: netlify
                  path: ${{ env.BUILD_DIR_NETLIFY }}

            - name: cache browsers
              id: playwright-cache
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-browsers

            - name: install browsers
              if: ${{ steps.playwright-cache.outputs.cache-hit != 'true' }}
              run: bunx playwright install chromium --only-shell

            - name: test accessibility
              continue-on-error: true
              run: bun run util:a11y --minimal --netlify

            - name: test lighthouse
              continue-on-error: true
              run: bun run util:lighthouse --netlify

    staging:
        name: Deploy to GitHub Pages
        runs-on: ubuntu-24.04
        needs: build
        if: ${{ needs.build.outputs.run_staging == 'true' }}
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        permissions:
            pages: write
            id-token: write
        steps:
            - name: github pages
              id: deployment
              uses: actions/deploy-pages@v4

    production:
        name: Deploy to Netlify
        runs-on: ubuntu-24.04
        needs: [build, test]
        if: ${{ needs.build.outputs.run_production == 'true' }}
        steps:
            - name: setup
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: download artifact
              uses: actions/download-artifact@v4
              with:
                  name: netlify
                  path: ./build

            - name: deploy
              run: >
                  bunx netlify-cli deploy --prod-if-unlocked --dir ./build
                  --message "${{ env.DEPLOY_MESSAGE }}"
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
                  DEPLOY_MESSAGE: ${{ github.event_name == 'repository_dispatch' && 'content update' || github.event.head_commit.message }}
