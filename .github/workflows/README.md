# GitHub Actions Workflow for Mikrouli

This workflow automates the CI/CD pipeline for the Mikrouli project, including
building, testing, and deploying to both staging (GitHub Pages) and production
(Netlify) environments. It also adds concurrency controls, extra checks, and
conditional logic to handle various GitHub event types.

---

## Step-by-Step Workflow Explanation

### **1. Workflow Configuration**

The workflow is defined in `ci.yml` and configured with:

#### Environment Variables

- `BUN_VERSION`: Specifies the version of Bun to use (e.g., `1.1.43`).
- `BUILD_DIR`, `BUILD_DIR_GITHUB`, `BUILD_DIR_NETLIFY`: Define build directories
  for GitHub Pages and Netlify artifacts.

#### Permissions

- Grants read access to actions and write access to contents (required for
  uploading artifacts).

#### Triggers

- **`push`**: Executes on code pushes to the `main` branch.
- **`pull_request`**: Executes on PR merges targeting `main`.
- **`repository_dispatch`**: Executes on external events (e.g., Contentful
  changes).
- _(Optional)_ **`workflow_dispatch`**: Allows manual deployments if you choose
  to enable them.

#### Concurrency

- Ensures only the latest run for the same branch/dispatch is kept.
- Cancels any in-progress runs if a newer one starts for the same concurrency
  group.

---

### **2. Job: Build**

#### Steps:

1. **Checkout Code**:
    - Uses `actions/checkout@v4` to pull the repository code.
2. **Setup Bun**:
    - Uses `oven-sh/setup-bun@v2` with the specified `BUN_VERSION`.
3. **Install Dependencies**:
    - Runs `bun install` to install required dependencies.
4. **Check (Lint/Type Check)**:
    - Skips if the event is `repository_dispatch`.
    - Typically runs `bun run check:ci` to perform linting/type checks.
5. **Generate Content**:
    - Runs `bun run util:content` if not a pull request.
    - Fetches/transforms data from Contentful using secrets.
6. **Build the Project**:
    - Runs `bun run build` to produce build artifacts (GitHub Pages by default).
7. **Upload Artifacts**:
    - If not a pull request, uploads using `actions/upload-pages-artifact@v3`.
8. **Browser Caching and Installation**:
    - Skips cache setup if `repository_dispatch`.
    - Caches Playwright browsers, installs Chromium on cache miss.
9. **Accessibility & Lighthouse Tests**:
    - Skips if `repository_dispatch`.
    - Uses `continue-on-error: true`, so issues don’t fail the entire CI.

---

### **3. Job: Deploy to GitHub Pages**

The `deploy-github` job runs after the `build` job to deploy the artifacts to
GitHub Pages. It is skipped for pull requests and relies on the artifacts
generated by the `build` job.

#### Steps

1. **Deploy to GitHub Pages**:
    - Uses `actions/deploy-pages@v4`, referencing the artifact uploaded by
      `build`.
    - Exposes the deployment URL via `deployment.outputs.page_url`.

---

### **4. Job: Deploy to Netlify**

The `deploy-netlify` job deploys the artifacts to Netlify, but only on manual
triggers (`workflow_dispatch`).

- **Pre-Launch**:
    - Runs only on manual triggers (`workflow_dispatch`) to prevent accidental
      production deploys.
- **Post-Launch**:
    - Could also trigger on `repository_dispatch` to auto-update production with
      new content.

#### Steps

1. **Setup Bun**:
    - Uses `oven-sh/setup-bun@v2`.
2. **Download Artifacts**:
    - Uses `actions/download-artifact@v4` to retrieve Netlify build artifacts.
3. **Deploy**:
    - Uses `bunx netlify deploy` (or similar) to update production.

---

### **Pre-Launch Strategy**

1. **GitHub Pages**:

    - Automatically deploy on:
        - Push to `main`
        - Pull request merges to `main`
        - Repository dispatch (e.g., Contentful changes)
    - Acts as a staging environment.

2. **Netlify**:
    - Deploy only via manual triggers (`workflow_dispatch`) until ready for
      public use.

---

### **Post-Launch Strategy**

1. **GitHub Pages**:

    - Remains staging.
    - Continues auto-deploy on push, PR, and dispatch events.

2. **Netlify**:
    - Can auto-deploy on Contentful updates (`repository_dispatch`), or remain
      manual.
    - Manual deploys stay available for emergency fixes or selective releases.

---

### **Deployment Rules**

| **Trigger**            | **Deploy to GitHub Pages?** | **Deploy to Netlify?**            | **Reasoning**                              |
|------------------------|-----------------------------|-----------------------------------|--------------------------------------------|
| **Push to `main`**     | ✅ Yes                       | ❌ No (unless changed post-launch) | Test changes in staging before production. |
| **PR Merge to `main`** | ✅ Yes                       | ❌ No (unless changed post-launch) | Validate changes on staging.               |
| **Contentful Change**  | ✅ Yes                       | ✅ Yes (if post-launch enabled)    | Keep production updated automatically.     |
| **Manual Deploy**      | ❌ No                        | ✅ Yes                             | Fine-grained control over production.      |

---

## Example YAML Configuration

### Pre-Launch Example

```yaml
deploy-netlify:
	if: ${{ github.event_name == 'workflow_dispatch' }}
# ...
```

### Post-Launch Example

```yaml
deploy-netlify:
	if: ${{
		github.event_name == 'repository_dispatch' ||
		github.event_name == 'workflow_dispatch'
	}}
# ...
```

---

> **Note**: As you finalize the production launch, adjust the Netlify job
> conditions to automatically deploy on Contentful changes. Use concurrency and
> conditions in `ci.yml` to ensure the pipeline runs efficiently while providing
> robust checks (such as accessibility and Lighthouse tests).
